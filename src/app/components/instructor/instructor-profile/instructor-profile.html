<div class="profile-page" *ngIf="!loading()">
  <!-- Floating decorative elements -->
  <div class="floating-element element-1">ğŸ“</div>
  <div class="floating-element element-2">ğŸ“š</div>
  <div class="floating-element element-3">â­</div>
  <div class="floating-element element-4">ğŸ’¡</div>

  <!-- Back Button - Positioned at top left -->
  <div class="back-button-top-left">
    <app-back-button></app-back-button>
  </div>

  <!-- Header / Banner -->
  <header class="profile-header">
    <div class="container">
      <div class="profile-info">
        <div class="avatar-placeholder">
          <ng-container *ngIf="publicInstructor() as p; else defaultAvatar">
            <img *ngIf="p.photoUrl" [src]="buildImageUrl(p.photoUrl)" alt="Instructor photo" />
            <mat-icon *ngIf="!p.photoUrl">person</mat-icon>
          </ng-container>
          <ng-template #defaultAvatar>
            <mat-icon>person</mat-icon>
          </ng-template>

          <!-- Photo Upload Button (Overlay) -->
          <div *ngIf="isOwnProfile()" class="avatar-overlay" (click)="openPhotoDialog()">
            <mat-icon>camera_alt</mat-icon>
          </div>
        </div>
        <div class="info-content">
          <div class="badges">
            <span class="badge">Instructor</span>
          </div>
          <h1 *ngIf="publicInstructor() as p">{{ p.fullName }}</h1>
          <p class="email" *ngIf="publicInstructor() as p">{{ p.email }}</p>

          <ng-container *ngIf="publicInstructor() as p">
            <div *ngIf="!editingBio()">
              <p class="specialization">{{ p.bio }}</p>
              <button *ngIf="isOwnProfile()" class="btn-edit-bio" (click)="toggleEditBio()">Edit Bio</button>
            </div>
            <div *ngIf="editingBio()" class="bio-edit">
              <textarea rows="4" class="bio-textarea" [ngModel]="bioDraft()" (ngModelChange)="bioDraft.set($event)"
                placeholder="Tell students about yourself..."></textarea>
              <div class="bio-actions">
                <button class="btn-save" (click)="saveBio()" [disabled]="savingBio()">{{ savingBio() ? 'Saving...' :
                  'Save' }}</button>
                <button class="btn-cancel" (click)="toggleEditBio()">Cancel</button>
              </div>
            </div>
          </ng-container>

          <div class="stats">
            <div class="stat-item">
              <span class="value">{{ courses().length }}</span>
              <span class="label">Courses</span>
            </div>
            <div class="stat-item">
              <span class="value">{{ students().length }}</span>
              <span class="label">Students</span>
            </div>
            <div class="stat-item" *ngIf="publicInstructor() as p">
              <span class="value">{{ p.averageRating | number:'1.1-2' }}</span>
              <span class="label">Rating</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="container content-section">
    <!-- Students Section -->
    <section class="students-section" *ngIf="students().length > 0">
      <h2>Enrolled Students</h2>
      <div class="students-list">
        <div *ngFor="let s of students()" class="student-card">
          <mat-icon>person</mat-icon>
          <div class="student-info">
            <strong>{{ s.studentName }}</strong>
          </div>
        </div>
      </div>
    </section>

    <h2>Courses</h2>

    <div *ngIf="courses().length === 0" class="empty-state">
      <mat-icon>school</mat-icon>
      <p>No courses found for this instructor.</p>
    </div>

    <div class="courses-grid" *ngIf="courses().length > 0">
      <mat-card *ngFor="let course of courses()" class="course-card" [routerLink]="['/course', course.courseId]">
        <img mat-card-image [src]="course.thumbnailUrl || 'assets/images/default-course.jpg'" alt="Course thumbnail"
          height="180">
        <mat-card-content>
          <h3 class="course-title">{{ course.title }}</h3>
          <div class="course-meta">
            <span class="price" *ngIf="course.price > 0">{{ course.price | currency }}</span>
            <span class="price free" *ngIf="course.price === 0">Free</span>
            <span class="rating">
              <mat-icon>star</mat-icon> {{ course.averageRating || 0 }}
            </span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <section class="reviews-section">
      <h2>Student Reviews</h2>
      <div *ngIf="reviews().length === 0" class="empty-state">
        <mat-icon>chat</mat-icon>
        <p>No reviews yet.</p>
      </div>

      <div class="reviews-list" *ngIf="reviews().length > 0">
        <mat-card *ngFor="let r of reviews()" class="review-card">
          <mat-card-content>
            <div class="review-meta">
              <strong>{{ r.studentName || 'Anonymous' }}</strong>
              <span class="rating">
                <mat-icon>star</mat-icon> {{ r.rating }} / 5
              </span>
              <span class="date">{{ r.createdAt | date:'mediumDate' }}</span>
            </div>
            <p class="comment">{{ r.comment }}</p>
          </mat-card-content>
        </mat-card>
      </div>
    </section>
  </main>
</div>

<div *ngIf="loading()" class="loading-container">
  <mat-spinner diameter="40"></mat-spinner>
  <p>Loading instructor profile...</p>
</div>

<div *ngIf="error() && !loading()" class="error-container">
  <mat-icon color="warn">error</mat-icon>
  <p>{{ error() }}</p>
  <button mat-raised-button color="primary" routerLink="/">Go Home</button>
</div>

<!-- Photo Upload Dialog -->
<app-photo-upload-dialog *ngIf="publicInstructor() as p" [isOpen]="isPhotoDialogOpen()" [userId]="p.userId"
  [currentPhotoUrl]="buildImageUrl(p.photoUrl)" (close)="closePhotoDialog()" (photoUpdated)="onPhotoUpdated($event)">
</app-photo-upload-dialog>